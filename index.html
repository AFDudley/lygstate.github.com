
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Octopress Blog</title>
  <meta name="author" content="Yonggang Luo">

  
  <meta name="description" content="Permalink C语言## __VA_ARGS__宏 在GNU C中，宏可以接受可变数目的参数，就象函数一样，例如: #define pr_debug(fmt,arg...) printk(KERN_DEBUG fmt, ##arg) 用可变参数宏(variadic macros) &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lygstate.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lygstate.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/22/simple-trace-implement-with-macros-in-c-slash-c-plus-plus/">Simple Trace Implement With Macros in C/C++</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-22T16:54:00+08:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.cnblogs.com/alexshi/archive/2012/03/09/2388453.html" title="Permalink to C语言 ## __VA_ARGS__ 宏 - AlexShi">Permalink</a></p>

<h2>C语言<code>## __VA_ARGS__</code>宏</h2>

<p>在GNU C中，宏可以接受可变数目的参数，就象函数一样，例如:</p>

<pre><code>#define pr_debug(fmt,arg...)  
printk(KERN_DEBUG fmt, ##arg) 
</code></pre>

<p>用可变参数宏(variadic macros)传递可变参数表</p>

<p>你可能很熟悉在函数中使用可变参数表，如:</p>

<pre><code>void printf(const char* format, ...); 
</code></pre>

<p>直到最近，可变参数表还是只能应用在真正的函数中，不能使用在宏中。</p>

<p>C99编译器标准终于改变了这种局面，它允许你可以定义可变参数宏(variadic macros)，这样你就可以使用拥有可以变化的参数表的宏。可变参数宏就像下面这个样子:</p>

<pre><code>#define debug(...) printf(__VA_ARGS__) 
</code></pre>

<p>缺省号代表一个可以变化的参数表。使用保留名 __VA_ARGS\__ 把参数传递给宏。当宏的调用展开时，实际的参数就传递给 printf()了。例如:</p>

<pre><code>Debug("Y = %dn", y); 
</code></pre>

<p>而处理器会把宏的调用替换成:</p>

<pre><code>printf("Y = %dn", y); 
</code></pre>

<p>因为debug()是一个可变参数宏，你能在每一次调用中传递不同数目的参数:</p>

<pre><code>debug("test");  // 一个参数 
</code></pre>

<p>可变参数宏不被ANSI/ISO C%2B%2B 所正式支持。因此，你应当检查你的编译器，看它是否支持这项技术。</p>

<p>用GCC和C99的可变参数宏， 更方便地打印调试信息</p>

<p>gcc的预处理提供的可变参数宏定义真是好用:</p>

<pre><code>#ifdef DEBUG 
#define dbgprint(format,args...)  
fprintf(stderr, format, ##args) 
#else 
#define dbgprint(format,args...) 
#endif 
</code></pre>

<p>如此定义之后，代码中就可以用dbgprint了，例如dbgprint(&#8220;%s&#8221;, __FILE__);</p>

<p>下面是C99的方法:</p>

<pre><code>#define dgbmsg(fmt,...)     printf(fmt,__VA_ARGS__) 
</code></pre>

<p>新的C99规范支持了可变参数的宏</p>

<p>具体使用如下:</p>

<p>以下内容为程序代码:</p>

<pre><code>#include  
#include  
#define LOGSTRINGS(fm, ...) printf(fm,__VA_ARGS__) 
int main() 
{ 
    LOGSTRINGS("hello, %d ", 10); 
    return 0; 
} 
</code></pre>

<p>但现在似乎只有gcc才支持。</p>

<p>可变参数的宏里的&#8217;##&#8217;操作说明带有可变参数的宏(Macros with a Variable Number of Arguments)</p>

<p>在1999年版本的ISO C 标准中，宏可以象函数一样，定义时可以带有可变参数。宏的语法和函数的语法类似。下面有个例子:</p>

<pre><code>#define debug(format, ...) fprintf (stderr, format, __VA_ARGS__) 
</code></pre>

<p>这里，&#8217;&#8230;&#8217;指可变参数。这类宏在被调用时，它(这里指&#8217;&#8230;&#8217;)被表示成零个或多个符号，包括里面的逗号，一直到到右括弧结束为止。当被调用时，在宏体(macro body)中，那些符号序列集合将代替里面的__VA_ARGS\__标识符。更多的信息可以参考CPP手册。</p>

<p>GCC始终支持复杂的宏，它使用一种不同的语法从而可以使你可以给可变参数一个名字，如同其它参数一样。例如下面的例子:</p>

<pre><code>#define debug(format, args...) fprintf (stderr, format, args) 
</code></pre>

<p>这和上面举的那个ISO C定义的宏例子是完全一样的，但是这么写可读性更强并且更容易进行描述。</p>

<p>GNU CPP还有两种更复杂的宏扩展，支持上面两种格式的定义格式。</p>

<p>在标准C里，你不能省略可变参数，但是你却可以给它传递一个空的参数。例如，下面的宏调用在ISO C里是非法的，因为字符串后面没有逗号:</p>

<p>debug (&#8220;A message&#8221;)</p>

<p>GNU CPP在这种情况下可以让你完全的忽略可变参数。在上面的例子中，编译器仍然会有问题(complain)，因为宏展开后，里面的字符串后面会有个多余的逗号。</p>

<p>为了解决这个问题，CPP使用一个特殊的&#8217;##&#8217;操作。书写格式为:</p>

<pre><code>#define debug(format, ...) fprintf (stderr, format, ## __VA_ARGS__) 
</code></pre>

<p>这里，如果可变参数被忽略或为空，&#8217;##&#8217;操作将使预处理器(preprocessor)去除掉它前面的那个逗号。如果你在宏调用时，确实提供了一些可变参数，GNU CPP也会工作正常，它会把这些可变参数放到逗号的后面。象其它的pasted macro参数一样，这些参数不是宏的扩展。</p>

<p><code>##</code>还可以起到替换作用</p>

<p>如:</p>

<pre><code>#define FUN(IName)  IName##_ptr 
</code></pre>

<p>这里将会把IName变成实际数据.</p>

<p>怎样写参数个数可变的宏</p>

<p>一种流行的技巧是用一个单独的用括弧括起来的的 &#8220;参数&#8221; 定义和调用宏, 参数在 宏扩展的时候成为类似 printf() 那样的函数的整个参数列表。</p>

<pre><code>#define DEBUG(args) (printf("DEBUG: "), printf args) 
if (n != 0) DEBUG(("n is %dn", n)); 
</code></pre>

<p>明显的缺陷是调用者必须记住使用一对额外的括弧。</p>

<p>gcc 有一个扩展可以让函数式的宏接受可变个数的参数。 但这不是标准。另一种 可能的解决方案是根据参数个数使用多个宏 (DEBUG1, DEBUG2, 等等), 或者用逗号玩个这样的花招:</p>

<pre><code>#define DEBUG(args) (printf("DEBUG: "), printf(args)) 
#define _ , 
DEBUG("i = %d" _ i); 
</code></pre>

<p>C99 引入了对参数个数可变的函数式宏的正式支持。在宏 &#8220;原型&#8221; 的末尾加上符号 &#8230; (就像在参数可变的函数定义中), 宏定义中的伪宏 __VA_ARGS\__ 就会在调用是 替换成可变参数。</p>

<p>最后, 你总是可以使用真实的函数, 接受明确定义的可变参数</p>

<p>如果你需要替换宏, 使用一个 函数和一个非函数式宏, 如 #define printf myprintf</p>

<h2>C/C++ TRACE</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>#define ENABLE(x) ENABLE_##x
</span><span class='line'>#define TRACE_LEVEL(level) level##_TRACE_LEVEL
</span><span class='line'>
</span><span class='line'>#define TRACE_LEVEL_FATAL 0
</span><span class='line'>#define TRACE_LEVEL_ERROR 1
</span><span class='line'>#define TRACE_LEVEL_WARNING 2
</span><span class='line'>#define TRACE_LEVEL_INFO 3
</span><span class='line'>#define TRACE_LEVEL_DEBUG 4
</span><span class='line'>
</span><span class='line'>#define TRACE_IMPL(error_level, module, format, ...) \
</span><span class='line'>    if (ENABLE(module) && error_level &lt;= TRACE_LEVEL(module)) {\
</span><span class='line'>        printf("[%s:%d %s %s %d]\r\n", #module, error_level, __FILE__, __FUNCTION__, __LINE__); \
</span><span class='line'>        printf(format, __VA_ARGS__);\
</span><span class='line'>    } \
</span><span class='line'>
</span><span class='line'>#define TRACE_FATAL(module, format, ...) TRACE_IMPL(TRACE_LEVEL_FATAL, module, format, __VA_ARGS__)
</span><span class='line'>#define TRACE_ERROR(module, format, ...) TRACE_IMPL(TRACE_LEVEL_ERROR, module, format, __VA_ARGS__)
</span><span class='line'>#define TRACE_WARNING(module, format, ...) TRACE_IMPL(TRACE_LEVEL_WARNING, module, format, __VA_ARGS__)
</span><span class='line'>#define TRACE_INFO(module, format, ...) TRACE_IMPL(TRACE_LEVEL_INFO, module, format, __VA_ARGS__)
</span><span class='line'>#define TRACE_DEBUG(module, format, ...) TRACE_IMPL(TRACE_LEVEL_DEBUG, module, format, __VA_ARGS__)
</span><span class='line'>
</span><span class='line'>void testTrace()
</span><span class='line'>{
</span><span class='line'>#define ENABLE_ACAS 1
</span><span class='line'>
</span><span class='line'>#define ACAS_TRACE_LEVEL TRACE_LEVEL_FATAL
</span><span class='line'>    TRACE_ERROR(ACAS, "Error\r\n");
</span><span class='line'>    TRACE_FATAL(ACAS, "Fatal\r\n");
</span><span class='line'>
</span><span class='line'>#define ACAS_TRACE_LEVEL TRACE_LEVEL_INFO
</span><span class='line'>    TRACE_INFO(ACAS, "Info\r\n");
</span><span class='line'>    TRACE_DEBUG(ACAS, "Debug\r\n");
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/24/xy-problem/">XY Problem</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-24T01:52:00+08:00" pubdate data-updated="true">Mar 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>&#8220;XY Problem&#8221; explanations by various people:</h3>

<p><a href="http://www.perlmonks.org/index.pl?node_id=542341">Every now and then I hear people say I might have an &#8220;XY problem&#8221;. What is that?</a></p>

<ul>
<li><p>You want to do X, and you think Y is the best way of doing so. Instead of asking about X, you ask about Y. <br>
— from <a href="http://www.perlmonks.org/index.pl?node_id=87035">&#8220;Re: sequencial file naming&#8221;</a> by Abigail</p></li>
<li><p>You&#8217;re trying to do X, and you thought of solution Y. So you&#8217;re asking about solution Y, without even mentioning X. The problem is, there might be a better solution, but we can&#8217;t know that unless you describe what X is. <br>
— from <a href="http://www.perlmonks.org/index.pl?node_id=430320">Re: How do I keep the command line from eating the backslashes?</a> by revdiablo</p></li>
<li><p>Someone asks how to do Y when they really want to do X. They ask how to do Y because they believe it is the best way to accomplish X. People trying to help go through many iterations of &#8220;try this&#8221;, followed by &#8220;that won&#8217;t work because of&#8221;. That is, depending on the circumstances, other solutions may be the way to go. <br>
— from <a href="http://www.perlmonks.org/index.pl?node_id=327963">Re: Re: Re: Re: regex to validate e-mail addresses and phone numbers</a> by Limbic~Region</p></li>
<li><p>To answer question Y, without understanding larger problem (the context) X, will most likely <em>not</em> help them entirely with X. <br>
— from <a href="https://groups.google.com/forum/?fromgroups=#!msg/comp.lang.perl.misc/rCCGCpipjH0/TBQOCAT9154J">The XY problem (was Re: CGI.pm: controlling Back &amp; Reload)
</a> by <a href="http://www.stonehenge.com/merlyn/">Randal L. Schwartz</a></p></li>
<li><p>A.k.a. &#8220;premature closure&#8221;: the questioner wanted to solve some not very clearly stated X, they concluded that Y was a component of a solution, and now they&#8217;re asking how to implement Y. <br>
— from <a href="https://groups.google.com/forum/?fromgroups=#!msg/comp.lang.perl.misc/rCCGCpipjH0/awehJE2Ck5YJ">Re: CGI.pm: controlling Back &amp; Reload</a> by Alan J. Flavell</p></li>
<li><p>The XY problem is when you need to do X, and you think you can use Y to do X, so you ask about how to do Y, when what you really should do is state what your X problem is. There may be a Z solution that is even better than Y, but nobody can suggest it if X is never mentioned. <br>
— from <a href="https://groups.google.com/forum/?fromgroups=#!msg/comp.lang.perl.misc/KGEh9CXPwQ0/TLmvdqBDV_AJ">Re: Compound scalar names?</a> by Tad McClellan</p></li>
<li><p>When people come [in here] asking how to do something stupid, I&#8217;m never quite sure what to do. I can just answer the question as asked, figuring that it&#8217;s not my problem to tell people that they&#8217;re being stupid&#8230; . But if I do that, people might jump on me for being a smart aleck, which has happened at times. (&#8220;Come on, help the poor guy out; if you know what he really need why don&#8217;t you just give it to him?&#8221;) <br>
&#8230; <br>
On the other hand, I could try to answer on a different level, present a better solution, and maybe slap a little education on &#8216;em. That&#8217;s nice when it works, but if it doesn&#8217;t it&#8217;s really sad to see your hard work and good advice ignored. Also, people tend to jump on you for not answering the question. (&#8220;Who are you to be telling this guy what he should be doing? Just answer the question.&#8221;)  <br>
&#8230; <br>
I guess there&#8217;s room for both kinds of answer. Or maybe there isn&#8217;t room for either kind. <br>
— from <a href="https://groups.google.com/forum/?fromgroups=#!msg/comp.programming/ygCTx6AN7ds/3S9Ei9saEbUJ">Why it&#8217;s stupid to <em>use a variable as a variable name</em></a> by Mark-Jason Dominus</p></li>
<li><p>The questions I like the best are the ones that go like this:</p>

<pre><code>  I want to accomplish X.

  I thought that the following code fragment would do it:

  ...

  But instead it does Y.

  Why is that?
</code></pre>

<p>This one is also pretty good:</p>

<pre><code>  I want to accomplish X.

  I thought I might be able to use facility Y.

  But Y doesn't seem like it's quite right, 
  because of Z.

  What should I use instead of Y, or how can I overcome Z?
</code></pre>

<p>— from <a href="https://groups.google.com/forum/?fromgroups=#!msg/comp.lang.perl/wu0T7a9orc0/3Q4PVIbEzZUJ" title="I never get answers to questions in newsgroups.">Re: system() question</a> by Mark-Jason Dominus</p></li>
<li><p>TIP: How to post good questions
In article <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#111;&#x3a;&#102;&#x6c;&#x5f;&#97;&#103;&#103;&#x69;&#101;&#45;&#x32;&#52;&#48;&#x36;&#x39;&#x38;&#x31;&#x32;&#52;&#x37;&#x35;&#x38;&#48;&#x30;&#48;&#49;&#x40;&#x61;&#103;&#103;&#105;&#101;&#x2e;&#x63;&#x6f;&#x61;&#x70;&#115;&#46;&#x66;&#115;&#117;&#x2e;&#x65;&#100;&#x75;">&#x66;&#x6c;&#x5f;&#97;&#x67;&#x67;&#x69;&#101;&#x2d;&#50;&#52;&#48;&#54;&#x39;&#56;&#x31;&#x32;&#52;&#55;&#x35;&#56;&#48;&#x30;&#48;&#49;&#64;&#x61;&#103;&#x67;&#x69;&#101;&#46;&#99;&#x6f;&#x61;&#x70;&#x73;&#46;&#x66;&#115;&#117;&#46;&#101;&#100;&#117;</a>, I R A Aggie <a href="&#109;&#97;&#x69;&#x6c;&#116;&#111;&#x3a;&#x66;&#x6c;&#95;&#x61;&#103;&#103;&#105;&#x65;&#64;&#x74;&#x68;&#x65;&#112;&#101;&#110;&#116;&#97;&#103;&#x6f;&#110;&#x2e;&#x63;&#x6f;&#x6d;">&#102;&#108;&#x5f;&#97;&#x67;&#x67;&#105;&#x65;&#64;&#x74;&#x68;&#101;&#112;&#101;&#110;&#x74;&#x61;&#103;&#111;&#x6e;&#46;&#99;&#x6f;&#x6d;</a> wrote:</p>

<blockquote><p>Dominus wrote:</p>

<blockquote><p>&#8220;How do I use X to accomplish Y?&#8221; There&#8217;s nothing wrong with this,
except that sometimes X is a chocolate-covered banana and Y is the
integration of European currency systems.</p></blockquote></blockquote></li>
</ul>


<p>A less abominable example of this that comes up all the time is</p>

<pre><code>I have an array of strings.  How do I check whether the array
contains a certain string?
</code></pre>

<p>Usually (not always, but usually) the best answer is to <code>unask the question</code>:</p>

<pre><code>You should be using a hash, not an array.
</code></pre>

<p>I wish I had a convenient term for this kind of mistake. The general case is:</p>

<ol>
<li>Someone wants to accomplish task Y.</li>
<li>They determine that a way to accomplish Y is to use facility X.</li>
<li>There is a sub-task of Y, say Z, for which X is ill-suited.</li>
<li>They come into the group and ask <code>"how can I use X to accomplish Z?"</code></li>
</ol>


<p>This is a problem for people here trying to answer the real question, which is:</p>

<pre><code>How can I accomplish Y?
</code></pre>

<p>— from <a href="http://perl.plover.com/Questions3.html">TIP: How to post good questions</a> by Mark-Jason Dominus</p>

<ul>
<li>Too bad that the more general problem, X, is often considered off topic for this forum. Y has more of a chance to look like a Perl problem. <br>
— from <a href="https://groups.google.com/forum/?fromgroups#!msg/comp.lang.perl.misc/rCCGCpipjH0/VUXQwCG8ICkJ">The XY problem (was Re: CGI.pm: controlling Back &amp; Reload)</a> by Bart Lateur</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/22/semaphore/">Semaphore, Mutex, Critical Section, SpinLock, Event</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-22T17:06:00+08:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Critical Section</h4>

<p>In concurrent programming, a critical section is a piece of code that accesses a shared resource (data structure or device) that must not be concurrently accessed by more than one thread of execution. A critical section will usually terminate in fixed time, and a thread, task, or process will have to wait for a fixed time to enter it (aka bounded waiting). Some synchronization mechanism is required at the entry and exit of the critical section to ensure exclusive use, for example a semaphore. (From wiki)</p>

<p>中文名叫做<strong>临界区</strong>.不论是硬件临界资源，还是软件临界资源，多个线程必须互斥地对它进行访问。由于不需要进入系统级(Mutex可以用于跨进程同步，因此是内核对象)，它比较轻量，效率会高很多（Windows下）。但是有的操作系统<strong>进程</strong>与<strong>线程</strong>是同一个概念，比如在VxWorks只有<strong>Task</strong>,在这种环境下，Mutex与Critical Section是等价的。</p>

<h5>Critical Section Usage</h5>

<p><strong>Example Code For Critical Sections with POSIX pthread library</strong></p>

<pre><code>/* Sample C/C++, Unix/Linux */
#include &lt;pthread.h&gt;

/* This is the critical section object (statically allocated). */
static pthread_mutex_t cs_mutex = PTHREAD_MUTEX_INITIALIZER;

void f()
{
    /* Enter the critical section -- other threads are locked out */
    pthread_mutex_lock( &amp;cs_mutex );

    /* Do some thread-safe processing! */

    /*Leave the critical section -- other threads can now pthread_mutex_lock()  */
    pthread_mutex_unlock( &amp;cs_mutex );
}

int main()
{
    f();

    return 0;
}
</code></pre>

<p><strong>Example Code For Critical Sections with Win32 API</strong></p>

<pre><code>/* Sample C/C++, Windows, link to kernel32.dll */
#include &lt;windows.h&gt;

static CRITICAL_SECTION cs; /* This is the critical section object -- once initialized,
                               it cannot be moved in memory */
                            /* If you program in OOP, declare this as a non-static member in your class */ 
void f()
{
    /* Enter the critical section -- other threads are locked out */
    EnterCriticalSection(&amp;cs);

    /* Do some thread-safe processing! */

    /* Leave the critical section -- other threads can now EnterCriticalSection() */
    LeaveCriticalSection(&amp;cs);
}

int main()
{
    /* Initialize the critical section before entering multi-threaded context. */
    InitializeCriticalSection(&amp;cs);

    f(); 

    /* Release system object when all finished -- usually at the end of the cleanup code */
    DeleteCriticalSection(&amp;cs);

    return 0;
}
</code></pre>

<h5>Critical Section 与 Mutex 的区别</h5>

<p>Critical Section不是一个核心对象，无法获知进入临界区的线程是生是死，如果进入临界区的线程挂了，没有释放临界资源，系统无法获知，而且没有办法释放该临界资源。而 Mutex 是有超时选项的，如果一个 Mutex 占用资源太久，那么会直接被释放。而且可以在其它进程销毁 Mutex对象，但是 Critical Section就不可以</p>

<h5>Critical Section properties</h5>

<p>Typically, critical sections prevent process and thread migration between processors and the preemption of processes and threads by interrupts and other processes and threads.</p>

<p>Critical sections often allow nesting. Nesting allows multiple critical sections to be entered and exited at little cost.
If the scheduler interrupts the current process or thread in a critical section, the scheduler will either allow the currently executing process or thread to run to completion of the critical section, or it will schedule the process or thread for another complete quantum. The scheduler will not migrate the process or thread to another processor, and it will not schedule another process or thread to run while the current process or thread is in a critical section.</p>

<p>Similarly, if an interrupt occurs in a critical section, the interrupt&#8217;s information is recorded for future processing, and execution is returned to the process or thread in the critical section. Once the critical section is exited, and in some cases the scheduled quantum completes, the pending interrupt will be executed. The concept of scheduling quantum applies to &#8220;Round Robin&#8221; and similar scheduling policies.</p>

<p>Since critical sections may execute only on the processor on which they are entered, synchronization is only required within the executing processor. This allows critical sections to be entered and exited at almost zero cost. No interprocessor synchronization is required, only instruction stream synchronization. Most processors provide the required amount of synchronization by the simple act of interrupting the current execution state. This allows critical sections in most cases to be nothing more than a per processor count of critical sections entered.</p>

<p>Performance enhancements include executing pending interrupts at the exit of all critical sections and allowing the scheduler to run at the exit of all critical sections. Furthermore, pending interrupts may be transferred to other processors for execution.</p>

<h5>Critical Section 使用注意事项</h5>

<p>Critical sections should not be used as a long-lived locking primitive. They should be short enough that the critical section will be entered, executed, and exited without any interrupts occurring, neither from hardware much less the scheduler.</p>

<h5>Critical Section under Linux is <em>futex</em></h5>

<p>The &#8216;fast&#8217; Windows equal of critical selection in Linux would be a futex, which stands for fast user space mutex. The difference between a futex and a mutex is that with a futex, the kernel only becomes involved when arbitration is required, so you save the overhead of talking to the kernel each time the atomic counter is modified. A futex can also be shared amongst processes, using the means you would employ to share a mutex.</p>

<p>Unfortunately, futexes can be very tricky to implement (PDF).</p>

<h4>Mutex (&#8220;mutual exclusion&#8221; lock)</h4>

<p>Mutex和critical section一样，用来保证同时只有一个线程进入某区域，通常用来实现对某单一资源的访问控制。Mutex可以设定time out，可以不像critical section一样死等。如果一个拥有Mutex的线程在返回之前没有调用ReleaseMutex()，那么这个Mutex就被舍弃了，但是当其他线程等待(WaitForSingleObject等)这个Mutex时，仍能返回，并得到一个WAIT_ABANDONED_0返回值。</p>

<p>A mutex (which stands for &#8220;mutual exclusion&#8221; lock) is a locking or synchronization object that allows multiple threads to synchronize access to shared resources. It is often used to ensure that shared variables are always seen by other threads in a consistent state.</p>

<p>In Windows, the mutexes are both named and un-named. The named mutex is shared between the threads of different process.</p>

<p>在MS Windows上API是CreateMutex(), OpenMutex(), ReleaseMutex(), WaitForSingleObject()和WaitForMultipleObjects()。用MFC库的CMutex类可以完成同样功能。</p>

<p>In Linux, the mutexes are shared only between the threads of the same process. To achieve the same functionality in Linux, a System V semaphore can be used (具体参考这篇文章).</p>

<p>支持POSIX库的系统(Linux/Unix)上有pthread_mutex_lock()和pthread_mutex_unlock()。</p>

<p>简单说CriticalSection is a user-mode component implemented by the Win32 subsystem, while Mutex is a kernel-mode component.
Practially, CriticalSection is much faster when there&#8217;s no actual blocking (due to reduction in user-kernel mode switches), and probably slower when there is blocking (due to more complex implementation). Additionally, since a Mutex is represented by a HANDLE, you can wait on a mutex with a timeout, or with several other handles. Neither option is available with a Critical Section. Mutexes can be named and shared between processes, while CriticalSections are restricted to the threads of a single process.</p>

<h4>Semaphore</h4>

<p>特点是有计数，同时可以有N个线程可以进入一个区域。Windows上的API有CreateSemaphore(), OpenSemaphore(), ReleaseSemaphore(), WaitForSingleObject()和WaitForMultipleObjects()。或者用MFC的CSemaphore类。</p>

<p>VxWorks没有Mutex, 它提供三种Semaphore: binary, counting, mutex. 相关API是semBCreate, semMCreate, semCCreate, semDelete, semTake, semGive, semFlush</p>

<p>在VxWork上，Mutex会触发prority inheritance. If a higher priority task is waiting for a semaphore
taken a low priority task and the low priority task, its priority will be temporarily changed to the high priority task which is waiting.</p>

<h4>Binary semaphore</h4>

<p>在有的系统中Binary semaphore与Mutex是没有差异的。在有的系统上，主要的差异是mutex一定要由获得锁的进程来释放。而semaphore可以由其它进程释放（这时的semaphore实际就是个原子的变量，大家可以加或减），因此semaphore可以用于进程间同步。Semaphore的同步功能是所有系统都支持的，而Mutex能否由其他进程释放则未定，因此建议mutex只用于保护critical section。而semaphore则用于保护某变量，或者同步。</p>

<h4>Event</h4>

<p>Event可以用来实现observer模式。创建一个Event，然后用WaitForSingleObject()挂起等待其它线程点亮(set)这个Event。我经常用的一个伎俩是在用户态创建一个Event的句柄，然后通过DeviceIoControl()把它传到驱动里面去，当驱动收到外部总线传来的数据包就点亮这个Event。Windows的API是CreateEvent(), OpenEvent(), SetEvent(), WaitForSingleObject(), WaitForMultipleObjects()。MFC库里有CEvent类。</p>

<h4>Spin lock</h4>

<p>spin lock是一个内核态概念。spin lock与semaphore的主要区别是spin lock是busy waiting，而semaphore是sleep。对于可以sleep的进程来说，busy waiting当然没有意义。对于单CPU的系统，busy waiting当然更没意义（没有CPU可以释放锁）。因此，只有多CPU的内核态非进程空间，才会用到spin lock。Linux kernel的spin lock在非SMP的情况下，只是关irq，没有别的操作，用于确保该段程序的运行不会被打断。其实也就是类似mutex的作用，串行化对 critical section的访问。但是mutex不能保护中断的打断，也不能在中断处理程序中被调用。而spin lock也一般没有必要用于可以sleep的进程空间。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/13/install-windows-with-iso-image-by-the-help-of-grub/">Windows Vista/2008/7全系列（x86、x64）ISO镜像文件硬盘安装方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-13T03:06:00+08:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://bbs.wuyou.com/viewthread.php?tid=148722" title="Windows Vista/2008/7全系列（x86、x64）ISO镜像文件硬盘安装方法">Permalink</a></p>

<p>本方法适合<code>移动硬盘</code>、<code>硬盘</code>、<code>U盘</code>、<code>USB读卡器</code>等可启动介质安装 <code>Windows Vista</code>、 <code>Windows 2008</code>、 <code>Windows 7</code> 全系列（X86、AMD64）系统。本方法和DVD光驱安装没有太大的差别，只是启动和中间会用到grub4dos/ImDisk来虚拟光驱; 还有本文中选用ImDisk作虚拟光驱软件， 是因为自己在别的WinPE里接触过，在别的方面也常用，大家可以选择适合自己的来代替都是可以的， ImDisk是我在x86/x64（2008/win7）上都测试过的。下面以 <code>移动硬盘+win7p64.iso</code> 为例</p>

<h4><strong><code>软件需求：</code></strong></h4>

<ul>
<li><code>Windows ISO镜像</code>， 此例中为<code>win7p64.iso</code>。 Windows Vista、 Windows 2008、 Windows7 全系列（x86、x64）都可以; 推荐放置在硬盘/移动硬盘上（速度快），此例中放在<code>移动硬盘</code>中：</li>
<li><a href="http://download.gna.org/grubutil/grubinst-1.1-bin-w32-2008-01-01.zip">grubinst</a> 用于<code>移动硬盘</code>（或其其它安装盘）引导扇区的写入。</li>
<li><a href="http://download.gna.org/grub4dos/grub4dos-0.4.4-2009-06-20.zip">grub4dos</a> 需要做成可启动的，可放在 <code>移动硬盘</code>、<code>硬盘</code>、U盘、USB读卡器、光盘、pxe服务器上。<br/>
如果ISO文件在USB设备上，grub4dos也应该装在同一个设备（大家可以试一试别的，能找到ISO文件就行）</li>
<li><a href="http://www.ltr-data.se/opencode.html/#ImDisk">ImDisk</a> 直接下载原版；默认带有x86、x64驱动，所以可以直接用于x86、x64版本安装。</li>
<li><a href="http://technet.microsoft.com/en-us/Sysinternals/Bb897428.aspx">Contig</a> 使文件以连续的方式存储。</li>
</ul>


<h4><strong><code>安装示例：</code></strong></h4>

<p>为了方便抓图，这里在VMware里用第二块硬盘模拟<code>移动硬盘</code>操作，假设该移动硬盘只有一个分区，并且识别成盘符X:</p>

<h6><code>制作移动硬盘:</code></h6>

<ul>
<li>解压缩下载到的<a href="http://download.gna.org/grubutil/grubinst-1.1-bin-w32-2008-01-01.zip">grubinst</a>， 执行里面的<code>grubinst_gui.exe</code>（以管理员模式运行），选择要写入的<code>磁盘</code>（这里是<code>移动硬盘</code>）,点击<code>安装</code>。</li>
<li>如果有错误 <code>grubinst: Bad partition table, if you're sure that the partition list is ok, please run this program again with --skip-mbr-test option.</code>
此时可以通过一下方法解决：<code>Go to disk management. Backup data if you have such on the USB disk. Delete all partitions. Create new ones. Set first one active.
Using safely remove hardware icon disconnect the disk. Replug it and try the program again.</code></li>
<li>如果无法删除所有分区，那么需要通过以下操作实现删除所有分区:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>There's no need to install any third-party programs, Windows already includes everything you need. Just open up command prompt and enter the following commands in sequence:
</span><span class='line'>
</span><span class='line'>DISKPART
</span><span class='line'>LIST DISK
</span><span class='line'>Select the disk that you want to correct. Example: I want to remove all partitions on Disk 1:
</span><span class='line'>
</span><span class='line'>SELECT DISK 1
</span><span class='line'>RECOVER
</span><span class='line'>If the RECOVER command doesn't work, try CLEAN.
</span><span class='line'>
</span><span class='line'>Disk 1 will be recovered as one complete disk.
</span><span class='line'>
</span><span class='line'>FORMAT &lt;option&gt;
</span><span class='line'>Where &lt;options&gt; represent what formatting method you'd prefer. Alternatively, use QUICK.</span></code></pre></td></tr></table></div></figure>


<ul>
<li>解压缩下载到的<a href="http://download.gna.org/grub4dos/grub4dos-0.4.4-2009-06-20.zip">grub4dos</a>， 复制里面的文件到<code>移动硬盘X:</code>根目录下。删除根目录下的<code>menu.lst</code>(让其自动进入命令模式)</li>
<li>解压缩下载到的<a href="http://www.ltr-data.se/opencode.html/#ImDisk">ImDisk</a>; 如果是可执行文件，照样可以解压缩。复制里面的文件到<code>移动硬盘X:</code>根目录下</li>
<li>复制win7p64.iso到<code>移动硬盘X:</code>根目录</li>
<li><p>解压缩下载到的<a href="http://technet.microsoft.com/en-us/Sysinternals/Bb897428.aspx">Contig</a>，复制Contig.exe到<code>移动硬盘X:</code>根目录， 执行以下命令:</p>

<pre><code>  pushd X: (`移动硬盘X:`根目录)
  Contig.exe win7p64.iso
</code></pre>

<p>Contig.exe的意义是为了让win7p64.iso连续存储； grub4dos需要调用 <code>map /win7p64.iso</code>，而文件win7p64.iso比较大，故这里不准备在grub4dos里把它整个map到内存；因此必须保证它在磁盘上是连续存放的。</p></li>
</ul>


<h6><strong><code>移动硬盘结构:</code></strong></h6>

<pre><code>X:
│  badgrub.exe
│  bootlace.com
│  ChangeLog_GRUB4DOS.txt
│  config.sys
│  COPYING
│  default
│  Get_Source_of_This_Build.txt
│  gpl.txt
│  grldr
│  grldr.mbr
│  grub.exe
│  grub.pif
│  hmload.com
│  imdisk.inf
│  install.cmd
│  menu.lst
│  msgbox.exe
│  readme.txt
│  README_GRUB4DOS.txt
│  runwait.exe
│  win7p64.iso
│
├─awealloc
│  ├─amd64
│  │      awealloc.sys
│  │
│  ├─i386
│  │      awealloc.sys
│  │
│  └─ia64
│          awealloc.sys
│
├─chinese
│      badgrub.exe
│      grldr
│      grub.exe
│
├─cli
│  ├─amd64
│  │      imdisk.exe
│  │
│  ├─i386
│  │      imdisk.exe
│  │
│  └─ia64
│          imdisk.exe
│
├─cpl
│  ├─amd64
│  │      imdisk.cpl
│  │
│  ├─i386
│  │      imdisk.cpl
│  │
│  └─ia64
│          imdisk.cpl
│
├─svc
│  ├─amd64
│  │      imdsksvc.exe
│  │
│  ├─i386
│  │      imdsksvc.exe
│  │
│  └─ia64
│          imdsksvc.exe
│
└─sys
    ├─amd64
    │      imdisk.sys
    │
    ├─i386
    │      imdisk.sys
    │
    └─ia64
            imdisk.sys
</code></pre>

<h6><strong><code>安装操作系统:</code></strong></h6>

<ol>
<li>设置BIOS引导盘为<code>移动硬盘</code>（也可以是U盘或是其它安装盘); 启动电脑；进入到grub4dos界面；如下图所示（图1）：<br/>
<img src="/images/2013/01/13/grub-init-interface.png" alt="Grub Init Interface" /></li>
<li><p>在GRUB命令模式下执行以下命令(注：命令要一字不差的全部输入，一行为一条命令，没有注释)：</p>

<pre><code> find --set-root /win7p64.iso
 map /win7p64.iso (0xff)
 map --hook
 chainloader (0xff)
 boot
</code></pre></li>
</ol>


<p>如果显示的win7p64.iso所在磁盘位置为(hd0,0)
那么重启电脑，执行以下命令:</p>

<pre><code>    map (hd0) (hd1)
    map (hd1) (hd0)
    find --set-root /win7p64.iso
    map /win7p64.iso (0xff)
    map --hook
    chainloader (0xff)
    boot
</code></pre>

<p>一般情况下执行情况如下图所示（图2）:<br/>
<img src="/images/2013/01/13/grub-commands.png" alt="Grub Commands" />
3. 下面进入正常的Win7安装,直到下图所示界面（图3）:<br/>
<img src="/images/2013/01/13/grub-no-dvd-error.jpg" alt="No CD/DVD" />
4. 上一步就因为找不到真实的光驱,所以报错,此时点击<code>Shift+F10</code>调出CMD窗口， 通过imdisk挂载<code>win7p64.iso</code>为虚拟光驱;执行以下一系列命令:</p>

<pre><code>    cd /d X:/imdisk (您那里可能是E: F:，即VMware虚拟硬盘所在的盘符,此为注释，或者U盘)
    install.bat
    cd ..
    imdisk -a -f "win7p64.iso" -m #:
</code></pre>

<p>执行情况如下图所示:<br/>
<img src="/images/2013/01/13/grub-install-dvd.jpg" alt="Install Virtual DVD" />
5. 执行完上一步,关闭cmd窗口,再关闭另外的可看到的那几个窗口,会返回到（图4）<br/>
<img src="/images/2013/01/13/grub-os-start-install.jpg" alt="Start Install OS" />
6. 点击&#8221;现在安装&#8221;,以下就和DVD光盘安装一样了,后面在重新启动机器的时候可以拔掉移动硬盘或USB设备(防止再从安装盘启动)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/13/sftp-access-to-amazon-ec2-using-filezilla/">SFTP Access to Amazon EC2 Using FileZilla</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-13T02:48:00+08:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.hermeswritings.com/index.php/2012/05/sftp-access-to-amazon-ec2-using-filezilla/" title="Permalink to SFTP Access To Amazon EC2 Using FileZilla « Hermes Writings">Permalink</a></p>

<p>After You can setup EC2 Instance on AWS next step is to upload files onto the server.</p>

<p>I have setup Ubunto instance and using Filezilla to connect to it after installation LAMP.</p>

<ul>
<li>Make sure port 22 is open in your instance’s Security Group in Amazon’s AWS site</li>
<li>Add .Pem Keys to FileZilla Click on <code>Edit &gt;&gt; setting &gt;&gt; SFTP &gt;&gt; Add Key File</code></li>
<li>Locate your PEM file. At this point FileZilla will ask if you want to convert it to a format it can use. Say <code>Yes</code> and tell it where to put the new .PPK file.</li>
<li>Close the Settings window.</li>
<li>Enter Host: like: <code>ec2-107-22-137-202.compute-1.amazonaws.com</code> or the <code>IP address</code>, user: <code>ubuntu</code> and port: <code>22</code>. Then click on Quick connect; It will connect with the following hints:</li>
</ul>


<p><img src="/images/2013/01/13/filezilla.jpg" alt="FileZilla Connection status" /></p>

<p><code>User name</code> might vary depending on your instance, by default ububtu instance username is ubuntu</p>

<p>Depending on the original AMI the instance is based on, you may want to double check that the correct user name is being used to authenticate.</p>

<p>Amazon Linux: <code>ec2-user</code><br/>
RHEL: <code>root</code><br/>
Ubuntu: <code>ubuntu</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/13/setting-up-ftp-server-on-ubuntu-amazon-ec2/">Setting Up FTP Server on Ubuntu - Amazon EC2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-13T02:16:00+08:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://curiousdeveloper.blogspot.com/2008/07/setting-up-ftp-server-on-ubuntu-amazon.html" title="Permalink to Setting up FTP Server on Ubuntu - Amazon EC2">Permalink</a></p>

<p>File Transfer Protocol (FTP) is a TCP protocol for uploading and downloading files between computers. FTP works on a client/server model. The server component is called an <em>FTP daemon</em>. It continuously listens for FTP requests from remote clients. When a request is received, it manages the the login and sets up the connection. For the duration of the session it executes any of commands sent by the FTP client.</p>

<p>Access to an FTP server can be managed in two ways:</p>

<p>In the Anonymous mode, remote clients can access the FTP server by using the default user account called &#8216;anonymous&#8221; or &#8220;ftp&#8221; and sending an email address as the password. In the Authenticated mode a user must have an account and a password. User access to the FTP server directories and files is dependent on the permissions defined for the account used at login. As a general rule, the FTP daemon will hide the root directory of the FTP server and change it to the FTP Home directory. This hides the rest of the file system from remote sessions.</p>

<h2>Amazon EC2: Unblock FTP port</h2>

<p>FTP works on port 21 by default. This port is blocked by the AWS firewall. You must unblock this port (21) by changing the instance permissions prior to setting up FTP so that you can access FTP remotely. This can be done using the AWS EC2 Elastic Fox client. Please refer to my other post about Unblocking ports on the Amazon EC2 for more details.</p>

<h2>vsftpd - FTP Server Installation</h2>

<p>vsftpd is an FTP daemon available in Ubuntu. It is easy to install, set up, and maintain. To install <strong>vsftpd</strong> you can run the following command:<br/>
<code>sudo apt-get install vsftpd</code></p>

<h2>vsftpd - FTP Server Configuration</h2>

<p>You can edit the vsftpd configuration file, <code>sudo vi /etc/vsftpd.conf</code>, to change the default settings. By default only anonymous FTP is allowed. If you wish to disable this option, you should change the following line:<br/>
<code>anonymous_enable=YES</code><br/>
to<br/>
<code>anonymous_enable=NO</code></p>

<p>By default, local system users are not allowed to login to FTP server. To change this setting, you should uncomment the following line:<br/>
<code>#local_enable=YES</code></p>

<p>By default, users are allowed to download files from FTP server. They are not allowed to upload files to FTP server. To change this setting, you should uncomment the following line:<br/>
<code>#write_enable=YES</code></p>

<p>Similarly, by default, the anonymous users are not allowed to upload files to FTP server. To change this setting, you should uncomment the following line:<br/>
<code>#anon\_upload\_enable=YES</code></p>

<p>The configuration file consists of many configuration parameters. The information about each parameter is available in the configuration file. Alternatively, you can refer to the man page, <strong>man 5 vsftpd.conf</strong> for details of each parameter.</p>

<p>Once you configure <strong>vsftpd</strong> you can start the daemon. You can run following command to run the <strong>vsftpd</strong> daemon:</p>

<p><code>sudo /etc/init.d/vsftpd start</code></p>

<p>Please note that the defaults in the configuration file are set as they are for security reasons. Each of the above changes makes the system a little less secure, so make them only if you need them.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/13/show-all-running-processes-in-linux/">Show All Running Processes in Linux</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-13T00:01:00+08:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.cyberciti.biz/faq/show-all-running-processes-in-linux/" title="Permalink to Show All Running Processes in Linux">Permalink</a></p>

<p>How do I see all running process in Linux?</p>

<p>You need to use the ps command. It provide information about the currently running processes, including their process identification numbers (PIDs). Both Linux and UNIX support ps command to display information about all running process. ps command gives a snapshot of the current processes. If you want a repetitive update of this status, use top command.</p>

<h2>ps command</h2>

<p>Type the following <strong>ps command</strong> to display all running process:<br/>
<code># ps aux | less</code><br/>
Where,</p>

<ul>
<li>-A: select all processes</li>
<li>a: select all processes on a terminal, including those of other users</li>
<li>x: select processes without controlling ttys</li>
</ul>


<h2>Task: see every process on the system</h2>

<p><code># ps -A# ps -e</code></p>

<h2>Task: See every process except those running as root</h2>

<p><code># ps -U root -u root -N</code></p>

<h2>Task: See process run by user vivek</h2>

<p><code># ps -u vivek</code></p>

<h2>Task: top command</h2>

<p>The top program provides a dynamic real-time view of a running system. Type the top at command prompt:<br/>
<code># top</code><br/>
Output:</p>

<p><img src="/images/2013/01/13/linux-unix-top-command.png" alt="Fig.01: top command: Display Linux Tasks" /><br/>
Fig.01: top command: Display Linux Tasks</p>

<p>To quit press <strong>q</strong>, for help press <strong>h</strong>.</p>

<h3>Task: display a tree of processes</h3>

<p>pstree shows running processes as a tree. The tree is rooted at either pid or init if pid is omitted. If a user name is specified, all process trees rooted at processes owned by that user are shown.<br/>
<code>$ pstree</code><br/>
Sample outputs:</p>

<p><img src="/images/2013/01/13/linux-unix-pstree-command.png" alt="Fig.02: pstree - Display a tree of processes" /><br/>
Fig.02: pstree - Display a tree of processes</p>

<h3>Task: Print a process tree using ps</h3>

<p><code>#  ps -ejH# ps axjf</code></p>

<h3>Task: Get info about threads</h3>

<p>Type the following command:<br/>
<code># ps -eLf# ps axms</code></p>

<h3>Task: Get security info</h3>

<p>Type the following command:<br/>
<code># ps -eo euser,ruser,suser,fuser,f,comm,label# ps axZ# ps -eM</code></p>

<h3>Task: Save Process Snapshot to a file</h3>

<p>Type the following command:<br/>
<code># top -b -n1 &amp;gt; /tmp/process.log</code><br/>
Or you can email result to yourself:<br/>
<code># top -b -n1 | mail -s 'Process snapshot' you@example.com</code></p>

<h2>Task: Lookup process</h2>

<p>Use pgrep command. pgrep looks through the currently running processes and lists the process IDs which matches the selection criteria to screen. For example display firefox process id:<br/>
<code>$ pgrep firefox</code><br/>
Sample outputs:</p>

<pre><code>3356
</code></pre>

<p>Following command will list the process called sshd which is owned by a user called root:<br/>
<code>$ pgrep -u root sshd</code></p>

<h2>Say hello to htop and atop</h2>

<p>htop is interactive process viewer just like top, but allows to scroll the list vertically and horizontally to see all processes and their full command lines. Tasks related to processes (killing, renicing) can be done without entering their PIDs. To install htop type command:<br/>
<code># apt-get install htop</code><br/>
or<br/>
<code># yum install htop</code><br/>
Now type the htop command at the shell prompt:<br/>
<code># htop</code><br/>
Sample outputs:<br/>
<img src="/images/2013/01/13/linux-unix-htop-command.png" alt="Fig.03: htop - Interactive Linux / UNIX process viewer" /><br/>
Fig.03: htop - Interactive Linux / UNIX process viewer</p>

<h3>atop program</h3>

<p>The program atop is an interactive monitor to view the load on a Linux system. It shows the occupation of the most critical hardware resources (from a performance point of view) on system level, i.e. cpu, memory, disk and network. It also shows which processes are responsible for the indicated load with respect to cpu- and memory load on process level; disk- and network load is only shown per process if a kernel patch has been installed. Type the following command to start atop:<br/>
<code># atop</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/12/building-a-socks-proxy-on-ec2/">Building a SOCKS Proxy on EC2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-12T21:15:00+08:00" pubdate data-updated="true">Jan 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://eric.gerlach.ca/blog/2012/6/19/building-a-socks-proxy-on-ec2-to-get-around-wifi-port-blocki.html">Permalink</a></p>

<p>At the NXNE Mobile Hackathon, we ran into a small problem. The wifi set up in the room would only allow connections over HTTP and HTTPS, which made it impossible to do many things you might want to do at a hackathon, like:</p>

<ol>
<li>Push to GitHub over SSH</li>
<li>Connect to MongoDB instances</li>
<li>Connect to&#8230; anything&#8230; that isn&#8217;t on ports 80 or 443&#8230; so a lot.</li>
</ol>


<p>If you can configure your tools correctly, the easiest way to get around this kind of problem is via a SOCKS proxy. Normally, I&#8217;d set up an SSH tunnel and run the SOCKS proxy over that&#8230; but no SSH. So the next best thing is to get a SOCKS server running on EC2. Let&#8217;s go through the steps required to set this up so that if you end up in the same situation, you can help those around you.</p>

<p>Doing this assumes that you temporarily have an internet connection that is unrestricted, like a tethered smartphone or a wired connection. I&#8217;m also assuming that you know your way around EC2 a bit.</p>

<ol>
<li>Connect to your unrestricted internet connection</li>
<li>Login to EC2</li>
<li>Ensure that you have a keypair setup</li>
<li>Create an EC2 Security Group that opens ports 22 and 443 to the world</li>
<li>Fire up an Ubuntu 12.04 LTS instance (micro will usually do) with your keypair and Security Group</li>
<li>SSH into the new machine with the SSH key (default username: ubuntu)</li>
<li><p>Run the following commands at the prompt or in a shell script:</p>

<pre><code> sudo apt-get install build-essential
 wget http://www.inet.no/dante/files/dante-1.3.2.tar.gz # or another version
 tar -zxvf dante-1.3.2.tar.gz
 cd dante-1.3.2
 ./configure
 make
 sudo make install
 $ sudo make me a sandwich
</code></pre></li>
<li><p>Put the following config in /etc/sock.conf<br/>
 <strong>Notice:</strong><br/>
 When use <code>internal: 127.0.0.1 port = 7071</code>, then the proxy address <em>is</em> <code>127.0.0.1:7071</code>.<br/>
 When use <code>internal: eth0 port = 7071</code>, and the IP binded to <code>eth0</code> is <code>10.210.235.113</code>,
 then the proxy address <strong>is</strong> <code>10.210.235.113:7071</code>, it&#8217;s the only proxy address.</p>

<pre><code> logoutput: /var/log/danted.log
 # But, when use eth0 instead, the the proxy addresss will turn out to be
 # the IP that binded to eth0, support the IP binded to eth0 is ``
 internal: 127.0.0.1 port = 7071
 #internal: eth0 port = 7071
 external: eth0
 method: username none

 #user.privileged: root
 user.notprivileged: nobody

 client pass {
   from: 127.0.0.1/32 port 1-65535 to: 0.0.0.0/0
 }

 client pass {
   from: 127.0.0.0/8 port 1-65535 to: 0.0.0.0/0
 }

 client block {
   from: 0.0.0.0/0 to: 0.0.0.0/0
   log: connect error
 }

 block {
   from: 0.0.0.0/0 to: 127.0.0.0/8
   log: connect error
 }

 pass {
   from: 127.0.0.1/32 to: 0.0.0.0/0
   protocol: tcp udp
 }

 pass {
   from: 127.0.0.0/8 to: 0.0.0.0/0
   protocol: tcp udp
 }

 block {
   from: 0.0.0.0/0 to: 0.0.0.0/0
   log: connect error
 }
</code></pre></li>
<li><p>Run <code>sudo sockd -D</code></p></li>
</ol>


<p>Now that we&#8217;ve got the server running, we have to configure our clients to connect to it. Fortunately, this is relatively easy. If you&#8217;re on linux, run your programs with tsocks. On Windows or Mac, you can try Proxifier (never tried it myself). Remember that the proxy is on port 443.</p>

<p>If you&#8217;re using PuTTY, you can set your proxy under Connection &gt; Proxy.</p>

<p>This set of steps creates an open proxy that anyone can use to proxy to anywhere. Don&#8217;t leave it running unless you want really big EC2 bills.</p>

<p>In doing this, I realized that it would be even better to be able to do this via a VPN instead of a SOCKS proxy in order to get better Windows and Mac full capture support. I&#8217;m going to play with this idea and post again when I&#8217;ve got something.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/12/converting-between-different-ssh-private-slash-public-key-formats/">Converting Between Different SSH Private/public Key Formats.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-12T16:00:00+08:00" pubdate data-updated="true">Jan 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>PuTTY &#8211;> SSH</h2>

<ul>
<li>PuTTY private key to SSH public key and private key.<br/>
<code>puttygen</code> supports exporting to an OpenSSH compatible format.

<ol>
<li>Open PuttyGen</li>
<li>Click Load</li>
<li>Load your private key</li>
<li>Go to <code>Conversions-&gt;Export OpenSSH</code> and export your private key</li>
<li>Copy your private key to <code>~/.ssh/id_dsa</code> (or <code>id_rsa</code>).</li>
<li>Create the RFC 4716 version of the public key using <code>ssh-keygen</code>:<br />
<code>ssh-keygen -e -f ~/.ssh/id_dsa &gt; ~/.ssh/id_dsa_com.pub</code></li>
<li>Convert the RFC 4716 version of the public key to the OpenSSH format:<br />
<code>ssh-keygen -i -f ~/.ssh/id_dsa_com.pub &gt; ~/.ssh/id_dsa.pub</code></li>
</ol>
</li>
<li>PuTTY public key to SSH public key<br/>
If all you have is a public key from a user in PuTTY-style format, you can convert it to standard openssh format like so:<br/>
<code>ssh-keygen -i -f keyfile.pub &gt; newkeyfile.pub</code></li>
</ul>


<p>See <a href="http://linux-sxs.org/networking/openssh.putty.html">this</a> and <a href="http://www.wellsi.com/sme/ssh/ssh.html">this</a> for more information.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/22/simple-trace-implement-with-macros-in-c-slash-c-plus-plus/">Simple Trace implement with macros in C/C++</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/24/xy-problem/">XY Problem</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/22/semaphore/">Semaphore, Mutex, Critical section, SpinLock, Event</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/13/install-windows-with-iso-image-by-the-help-of-grub/">Windows Vista/2008/7全系列（x86、x64）ISO镜像文件硬盘安装方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/13/sftp-access-to-amazon-ec2-using-filezilla/">SFTP Access To Amazon EC2 Using FileZilla</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Yonggang Luo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
